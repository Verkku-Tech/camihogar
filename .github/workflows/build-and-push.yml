name: Build and Push Docker Images

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_IMAGE_PREFIX: ${{ secrets.DOCKER_USERNAME }}/camihogar

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build Frontend
      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./FrontendCamihogar
          file: ./FrontendCamihogar/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-frontend:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-frontend:latest
          cache-to: type=inline

      # Build Backend Services
      - name: Build and push Security API
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Application/Security/Ordina.Security.Api/Ordina.Security.Api.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-security-api:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-security-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-security-api:latest
          cache-to: type=inline

      - name: Build and push Users API
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Application/Users/Ordina.Users.Api/Ordina.Users.Api.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-users-api:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-users-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-users-api:latest
          cache-to: type=inline

      - name: Build and push Providers API
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Application/Providers/Ordina.Providers.Api/Ordina.Providers.Api.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-providers-api:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-providers-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-providers-api:latest
          cache-to: type=inline

      - name: Build and push Orders API
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Application/Orders/Ordina.Orders.Api/Ordina.Orders.Api.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-orders-api:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-orders-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-orders-api:latest
          cache-to: type=inline

      - name: Build and push Payments API
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Application/Payments/Ordina.Payments.Api/Ordina.Payments.Api.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-payments-api:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-payments-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-payments-api:latest
          cache-to: type=inline

      - name: Build and push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: ./Ordina.Backend
          file: ./Ordina.Backend/Dockerfile
          build-args: |
            PROJECT_PATH=src/Presentation/Ordina.ApiGateway/Ordina.ApiGateway.csproj
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_PREFIX }}-apigateway:latest
            ${{ env.DOCKER_IMAGE_PREFIX }}-apigateway:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_PREFIX }}-apigateway:latest
          cache-to: type=inline

      - name: Summary
        run: |
          echo "âœ… All images pushed successfully!"
          echo "Frontend: ${{ env.DOCKER_IMAGE_PREFIX }}-frontend:latest"
          echo "Security API: ${{ env.DOCKER_IMAGE_PREFIX }}-security-api:latest"
          echo "Users API: ${{ env.DOCKER_IMAGE_PREFIX }}-users-api:latest"
          echo "Providers API: ${{ env.DOCKER_IMAGE_PREFIX }}-providers-api:latest"
          echo "Orders API: ${{ env.DOCKER_IMAGE_PREFIX }}-orders-api:latest"
          echo "Payments API: ${{ env.DOCKER_IMAGE_PREFIX }}-payments-api:latest"
          echo "API Gateway: ${{ env.DOCKER_IMAGE_PREFIX }}-apigateway:latest"

